{% extends "base.html" %}

{% block styles %}
<style>
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        padding: 1rem;
    }
    .media-item {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .media-item:hover {
        transform: translateY(-5px);
    }
    .media-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .media-item .media-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.5rem;
        transform: translateY(100%);
        transition: transform 0.2s;
    }
    .media-item:hover .media-overlay {
        transform: translateY(0);
    }
    .upload-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    .upload-zone:hover {
        border-color: #007bff;
    }
    .upload-zone.dragover {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Media Library</h5>
                </div>
                <div class="card-body">
                    <!-- Upload Zone -->
                    <div class="upload-zone mb-4" id="uploadZone">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <h5>Drop files here</h5>
                        <p class="text-muted">or click to select files</p>
                        <input type="file" id="fileInput" multiple style="display: none">
                    </div>

                    <!-- Filters -->
                    <div class="mb-3">
                        <label class="form-label">Filter by Type</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="image">Images</option>
                            <option value="video">Videos</option>
                            <option value="document">Documents</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Sort by</label>
                        <select class="form-select" id="sortBy">
                            <option value="date_desc">Newest First</option>
                            <option value="date_asc">Oldest First</option>
                            <option value="name_asc">Name A-Z</option>
                            <option value="name_desc">Name Z-A</option>
                            <option value="size_desc">Size (Largest)</option>
                            <option value="size_asc">Size (Smallest)</option>
                        </select>
                    </div>

                    <!-- Storage Usage -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Storage Usage</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {% if storage_usage_percent %}{{ storage_usage_percent }}{% else %}0{% endif %}%"
                                     aria-valuenow="{% if storage_usage_percent %}{{ storage_usage_percent }}{% else %}0{% endif %}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {% if storage_usage_percent %}{{ storage_usage_percent|round(1) }}{% else %}0{% endif %}%
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ storage_used|filesizeformat }} of {{ storage_total|filesizeformat }} used
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Toolbar -->
            <div class="card mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" id="selectAll">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                        <button class="btn btn-outline-danger" id="deleteSelected" disabled>
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                        <button class="btn btn-outline-secondary" id="downloadSelected" disabled>
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary active" data-view="grid">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="btn btn-outline-secondary" data-view="list">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                        <input type="text" class="form-control" placeholder="Search media..." id="searchMedia">
                    </div>
                </div>
            </div>

            <!-- Media Grid -->
            <div class="media-grid" id="mediaGrid">
                {% for item in media_items %}
                <div class="media-item" data-type="{{ item.type }}" data-id="{{ item.id }}">
                    {% if item.type == 'image' %}
                    <img src="{{ item.url }}" alt="{{ item.name }}">
                    {% elif item.type == 'video' %}
                    <div class="video-thumbnail">
                        <i class="fas fa-play-circle fa-3x"></i>
                    </div>
                    {% else %}
                    <div class="document-thumbnail">
                        <i class="fas fa-file fa-3x"></i>
                    </div>
                    {% endif %}
                    <div class="media-overlay">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-truncate">{{ item.name }}</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light" onclick="copyUrl('{{ item.url }}')">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="btn btn-sm btn-light" onclick="downloadMedia('{{ item.id }}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-light" onclick="deleteMedia('{{ item.id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <small class="text-muted">{{ item.size|filesizeformat }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Media pages" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.media', page=pagination.prev_num) }}">Previous</a>
                    </li>
                    {% endif %}

                    {% for page in pagination.iter_pages() %}
                        {% if page %}
                            {% if page != pagination.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.media', page=page) }}">{{ page }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.media', page=pagination.next_num) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Media Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="previewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadPreview">Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // File Upload Handling
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('files[]', file);
        });

        fetch('/admin/media/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Upload failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed');
        });
    }

    // Media Selection
    let selectedItems = new Set();
    const mediaItems = document.querySelectorAll('.media-item');
    const deleteSelectedBtn = document.getElementById('deleteSelected');
    const downloadSelectedBtn = document.getElementById('downloadSelected');

    mediaItems.forEach(item => {
        item.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-group')) {
                item.classList.toggle('selected');
                const itemId = item.dataset.id;
                if (selectedItems.has(itemId)) {
                    selectedItems.delete(itemId);
                } else {
                    selectedItems.add(itemId);
                }
                updateButtons();
            }
        });
    });

    function updateButtons() {
        const hasSelection = selectedItems.size > 0;
        deleteSelectedBtn.disabled = !hasSelection;
        downloadSelectedBtn.disabled = !hasSelection;
    }

    // Utility Functions
    window.copyUrl = function(url) {
        navigator.clipboard.writeText(url).then(() => {
            alert('URL copied to clipboard!');
        });
    };

    window.downloadMedia = function(id) {
        window.location.href = `/admin/media/download/${id}`;
    };

    window.deleteMedia = function(id) {
        if (confirm('Are you sure you want to delete this item?')) {
            fetch(`/admin/media/delete/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Delete failed: ' + data.error);
                }
            });
        }
    };

    // Search and Filter
    const searchInput = document.getElementById('searchMedia');
    const typeFilter = document.getElementById('typeFilter');
    const sortBy = document.getElementById('sortBy');

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedType = typeFilter.value;
        
        mediaItems.forEach(item => {
            const type = item.dataset.type;
            const name = item.querySelector('.text-truncate').textContent.toLowerCase();
            const matchesSearch = name.includes(searchTerm);
            const matchesType = !selectedType || type === selectedType;
            
            item.style.display = matchesSearch && matchesType ? 'block' : 'none';
        });
    }

    searchInput.addEventListener('input', applyFilters);
    typeFilter.addEventListener('change', applyFilters);
    sortBy.addEventListener('change', () => {
        location.href = `/admin/media?sort=${sortBy.value}`;
    });

    // View Toggle
    const viewButtons = document.querySelectorAll('[data-view]');
    const mediaGrid = document.getElementById('mediaGrid');

    viewButtons.forEach(button => {
        button.addEventListener('click', () => {
            viewButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            mediaGrid.className = button.dataset.view === 'grid' ? 'media-grid' : 'media-list';
        });
    });
});
</script>
{% endblock %}
